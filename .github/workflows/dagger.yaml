name: Dagger Build, Lint and Test
on:
  pull_request: {}

jobs:
    dagger:
        name: Dagger Build, Lint and Test
        runs-on: ubuntu-24.04
        steps:
            - name: Restore Cache
              id: cache-restore
              uses: actions/cache/restore@v4
              with:
                key: cache-${{ github.repository }}
                path: |
                  ${{ github.workspace }}/cache
            - name: Check cache
              run: |
                mkdir -p ${{ github.workspace }}/cache
                tree -L 2 ${{ github.workspace }}/cache
            - name: Initialize empty cache if necessary
              if: steps.cache-restore.outputs.cache-hit != 'true'
              run: |
                mkdir -p ${{ github.workspace }}/cache/ccache
                mkdir -p ${{ github.workspace }}/cache/CPM
            - name: Setup Dagger
              uses: dagger/dagger-for-github@8.0.0
              with:
                version: 0.18.12
                workdir: ${{ github.workspace }}
                module: github.com/${{ github.repository}}@${{ github.ref }}
                call:  --cache-dir ${{ github.workspace }}/cache pull-requestoutputs export --path outputs
            - name: Save Cache
              uses: actions/cache/save@v4
              with:
                key: cache-${{ github.repository }}
                path: ${{ github.workspace }}/outputs/cache
            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                name: all-artifacts
                path: ${{ github.workspace }}/outputs/artifacts

