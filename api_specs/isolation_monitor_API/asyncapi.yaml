---
asyncapi: 3.0.0
id: 'pionix:de:basecamp:isolation_monitor_API'
info:
  title: Basecamp API definition for isolation monitors
  version: 1.0.1
  description: >-
    This document contains the description of the API for basecamp drivers supporting isolation monitors.
    Isolation monitors with corresponding capabilites have to be installed in the charger. In order to add support for a specific isolation monitor this API has to be used. It is guaranteed to be stable for the current major release. Additional functionality not breaking existing code may be added with minor releases.
  license:
    name: BaseCamp - License Version 1.0
    url: https://www.pionix.de/pionix-license-terms
  tags:
    - name: basecamp
    - name: isolation monitor
servers:
  default:
    pathname: 'basecamp/api/1.0/isolation_monitor/{module_id}'
    host: 'localhost:1883'
    description: default local MQTT
    protocol: mqtt
    variables:
      module_id:
        description: The ID of the module as defined by `cfg_target_module_id` in basecamp config file.
defaultContentType: application/json

channels:
  receive_start:
    address: 'b2m/receive_start'
    messages:
      receive_start:
        $ref: '#/components/messages/receive_start'
  receive_stop:
    address: 'b2m/receive_stop'
    messages:
      receive_stop:
        $ref: '#/components/messages/receive_stop'
  receive_start_self_test:
    address: 'b2m/receive_start_self_test'
    messages:
      receive_start_self_test:
        $ref: '#/components/messages/receive_start_self_test'
  send_isolation_measurement:
    address: 'm2b/isolation_measurement'
    messages:
      send_isolation_measurement:
        $ref: '#/components/messages/send_isolation_measurement'
  send_self_test_result:
    address: 'm2b/self_test_result'
    messages:
      send_self_test_result:
        $ref: '#/components/messages/send_self_test_result'
  send_raise_error:
    address: 'm2b/raise_error'
    messages:
      send_raise_error:
        $ref: '#/components/messages/send_raise_error'
  send_clear_error:
    address: 'm2b/clear_error'
    messages:
      send_clear_error:
        $ref: '#/components/messages/send_clear_error'
  send_communication_check:
    address: 'm2b/communication_check'
    messages:
      send_communication_check:
        $ref: '#/components/messages/send_communication_check'
  receive_heartbeat:
    address: 'b2m/heartbeat'
    messages:
      receive_heartbeat:
        $ref: '#/components/messages/receive_heartbeat'


operations:
  receive_start:
    title: Receive start command
    summary: 'Direction: BaseCamp to Module'
    description:  By receiving the start command the monitoring of the isolation status should be started. Measurement data should be sent in user dependent interval until the stop command is received.
    action: receive
    channel:
      $ref: '#/channels/receive_start'
  receive_stop:
    title: Receive stop command
    summary: 'Direction: BaseCamp to Module'
    description:  By receiving the stop command the monitoring of the isolation status should be stoped. Measurement data must not be sent until the next start command is received.
    action: receive
    channel:
      $ref: '#/channels/receive_stop'
  receive_start_self_test:
    title: Receive start self test command
    summary: 'Direction: BaseCamp to Module'
    description: The EvseManager will enable a DC voltage to support the testing, but will not enable output relais such that there is no high voltage on the external plug. The "self_test_result" variable must be published once the self testing is done.
    action: receive
    channel:
      $ref: '#/channels/receive_start_self_test'
  send_isolation_measurement:
    title: Send isolation measurement
    summary: 'Direction: Module to BaseCamp'
    description: This operation is used to send a dataset of measured values. The isolation resistance (in Ohm) is required. The voltage is optional.
    action: send
    channel:
      $ref: '#/channels/send_isolation_measurement'
  send_self_test_result:
    title: Send self test result
    summary: 'Direction: Module to BaseCamp'
    description: This operation is used to send the result of the self test.
    action: send
    channel:
      $ref: '#/channels/send_self_test_result'
  send_raise_error:
    title: Send raise error
    action: send
    channel:
      $ref: '#/channels/send_raise_error'
    description: 'Direction: Module to BaseCamp'
  send_clear_error:
    title: Send clear error
    action: send
    channel:
      $ref : '#/channels/send_clear_error'
  send_communication_check:
    title: Send communication check
    action: send
    channel:
      $ref : '#/channels/send_communication_check'
  receive_heartbeat:
    title: Receive heatbeat
    action: receive
    channel:
      $ref: '#/channels/receive_heartbeat'


components:
  messages:
    receive_start:
      title: Receive start command
      summary: Start recurring isolation measurements. The device should monitor the isolation status until stopped and publish the resistance data in regular intervals. The actual interval is device dependent.
      contentType: application/json
      payload: {}
    receive_stop:
      title: Receive stop command
      summary: Stop recurring measurements. The device should stop to monitor the isolation resistance and stop publishing the data.
      contentType: application/json
      payload: {}
    receive_start_self_test:
      title: Receive start self test command
      summary: Start self test. EvseManager will enable a DC voltage to support the testing, but will not enable output relais such that there is no high voltage on the external plug.
      contentType: application/json
      payload:
        $ref: '#/components/schemas/SelfTestVoltage'
    send_isolation_measurement:
      title: Send isolation monitor measurement
      summary: 'Isolation monitoring measurement results'
      contentType: application/json
      payload:
        $ref: '#/components/schemas/IsolationMeasurement'
      examples:
        - summary: ""
          payload:
            "resistance_F_Ohm": 0
            "voltage_V": 0
    send_self_test_result:
      title: Send self test result
      summary: 'Self test result'
      contentType: application/json
      payload:
        $ref: '#/components/schemas/SelfTestResult'
      examples:
        - summary: ""
          payload:
            true
    send_raise_error:
      title: Send raise error
      summary: Signal to BaseCamp that an error happened.
      contentType: application/json
      payload:
        $ref: '#/components/schemas/Error'
      examples:
        - summary: ""
          payload:
            "type": "CommunicationFault"
            "sub_type": "string"
            "message": "string"
    send_clear_error:
      title: Send clear error
      summary: Signal to BaseCamp that a preciously raised error is no longer active.
      contentType: application/json
      payload:
        $ref: '#/components/schemas/Error'
      examples:
        - summary: ""
          payload:
            "type": "CommunicationFault"
            "sub_type": "string"
            "message": "string"
    send_communication_check:
      title: Send communication check
      summary: Signal to BaseCamp that communication is good or check shall be stopped
      contentType: application/json
      payload:
        $ref: '#/components/schemas/CommunicationCheck'
      examples:
        - summary: ""
          payload:
            true
    receive_heartbeat:
      title: Receive heartbeat
      summary: Heartbeat produced by basecamp as configured via cfg_heartbeat_interval_ms in the basecamp configuration
      contentType: application/json



  schemas:
    IsolationMeasurement:
      description: Results of an isolation measurement
      type: object
      additionalProperties: true
      required:
        - resistance_F_Ohm
      properties:
        resistance_F_Ohm:
          description: 'Isolation resistance between DC+/DC- and protective earth in Ohm'
          type: number
        voltage_V:
          description: DC voltage between positive and negative terminal in Volt
          type: number
    SelfTestResult:
      description: >-
        Indicates the self test is done and publishes the result.
        Set "true" for success, "false" for failure.
      type: boolean

    ErrorEnum:
      description: |
        Type of error
        - DeviceFault: The IMD device is not fully functional anymore and cannot be used to monitor the isolation resistance.
        - CommunicationFault: The communication to the hardware or underlying driver is lost or has errors.
        - VendorError: Vendor specific error code. Will stop charging session.
        - VendorWarning:  Vendor specific error code. Charging may continue.

        type: string
        enum:
          - DeviceFault
          - CommunicationFault
          - VendorError
          - VendorWarning

    Error:
      description: >-
         Errors for Isolation Monitor

         Note that actual isolation faults should just be reported as resistance values,
         EvseManager will interpret them according to the limits given in the norm and stop charging.

         This is only to report device errors to indicate valid isolation resistance measurements etc
         are no longer possible.
      type: object
      additionalProperties: true
      required:
        - type
      properties:
        type:
          $ref: '#/components/schemas/ErrorEnum'
        sub_type:
          description: The subtype of the error
          type: string
        message:
          description: Addition information about the error
          type: string

    CommunicationCheck:
      type: boolean
      description: "Send 'true' at least every 'cfg_communication_check_to_s' seconds to signal module is alive. Send 'false' to stop communication check'"

    SelfTestVoltage:
      type: number
      description: "Voltage for the isolation monitor self test"
