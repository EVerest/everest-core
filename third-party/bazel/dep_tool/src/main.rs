extern crate serde_yaml;
use serde::Deserialize;
use std::collections::BTreeMap;
use argh::FromArgs;

#[derive(Debug, Deserialize)]
struct DependencyDescriptor {
    git: String,
    git_tag: String,
    options: Option<Vec<String>>,
    cmake_condition: Option<String>,
}

#[derive(FromArgs)]
/// A tool to parse dependencies.yaml and generate bazel dependencies file
struct Args {
    /// path to dependencies.yaml
    #[argh(positional)]
    path: String,
}

fn sanitize_name(name: &str) -> String {
    name.replace("-", "_")
}

fn main() {
    let args: Args = argh::from_env();
    eprintln!("Reading dependencies from {}", args.path);
    let deps = std::fs::read_to_string(args.path).unwrap();
    let deps: BTreeMap<String, DependencyDescriptor> = serde_yaml::from_str(&deps).unwrap();

    println!("# This file is generated by dep_tool. Do not edit manually.");
    println!("# To regenerate this file, after changing dependencies.yaml run:");
    println!("#");
    println!("#     bazel run //:update");
    println!("");
    println!("EVEREST_DEPS = struct(");
    for (name, dep) in deps {
        println!("\t# {}", name);
        println!("\t{}_repo = \"{}\",", sanitize_name(&name), dep.git);
        println!("\t{}_tag = \"{}\",", sanitize_name(&name), dep.git_tag);
        println!("");
    }
    println!(")");
}
