description: >-
  This interface defines a fast over voltage monitoring device according
  to IEC61851-23:2023 6.3.1.106.2 and 6.3.1.106.3 for DC charging. 
  
  6.3.1.106.2
  An emergency shutdown needs to be triggered if the DC output voltage is above the limit of Table 103 for 9ms. 
  The actual shutdown needs to be handled in a lower layer outside of EVerest, but this interface sets the 
  correct voltage limit during the power transfer and stops monitoring at the end of the session. 
  After the actual emergency shutdown was already performed, report an MREC5OverVoltage error with severity set to high. 

  6.3.1.106.3
  An error shutdown needs to be triggered if the DC output voltage is above the limits of Table 104:
    - Present voltage > negotiated maximum for >400ms: Trigger error shutdown in <50ms.
    - Present voltage > negotiated maximum for <400ms and >200ms: Allow energy transfer or error shutdown
    - Present voltage > negotiated maximum for <200ms: Allow energy transfer
  To trigger an error shutdown, raise the error MREC5OverVoltage with severity set to medium or low.

  Once an MREC5OverVoltage error was raised, it shall only be cleared when the reset_over_voltage_error command is called.
  All other errors shall be raised/cleared when they occur/are no longer active immediately.

  The var voltage_measurement_V should be published in regular intervals, e.g. 1 second. It is not
  used to compare it with the overvoltage threshold setting in EVerest, that has to be done in the OVM device itself.
  It will only be used to validate that the OVM and the IMD see the same voltage to ensure they are correctly wired to the same
  charging port. If it is not available in hardware, do not publish the voltage_measurement_V at all.
cmds:
  set_limits:
    description: >-
      Set the overvoltage limits. It will be called any time the voltage limits change, independent of 
      whether the monitoring is currently active or not.
      The values shall be cached, and the last value received shall be used as threshold while monitoring is active.
    arguments:
      emergency_over_voltage_limit_V:
        description: >-
          Specifies the over voltage threshold [V] for emergency shutdown
          (based on IEC61851-23:2023 Table 103 and IEC61851-23-3:(DRAFT 2025) Table 202)
          An emergency shutdown shall be triggered if the DC output voltage is higher 
          than this value.
        type: number
      error_over_voltage_limit_V:
        description: >-
          Specifies the over voltage threshold [V] for error shutdown (for use with IEC61851-23:2023 Table 104).
          An error shutdown shall be triggered if the DC output voltage is higher 
          than this value. The OVM shall trigger an emergency shutdown if error shutdown does not work properly
          (after 2.5s, see CC.3.4.2).
        type: number
  start:
    description: >-
      Start monitoring. Called once at the beginning of power transfer.
      Use the last limits set by set_limits and make sure to update them when set_limits is called while monitoring is active.
      Trigger shutdowns and raise errors as needed.
  stop:
    description: >-
      Stop monitoring. Called once at the end of power transfer.
      Do not raise any over voltage errors or trigger any shutdowns in this mode.
  reset_over_voltage_error:
    description: >-
      Resets the detection logic to allow for new charging session after an over voltage error occurred.
      This shall clear the over voltage error.
      If monitoring is still active, it shall be stopped.
vars:
  voltage_measurement_V:
    description: Measured voltage in V
    type: number
errors:
  - reference: /errors/over_voltage_monitor
