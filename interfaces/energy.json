{
    "description": "This interface defines a forecast schedule of energy import/export capability/limits, pricing and current energy usage.",
    "cmds": {
        "enforce_limits": {
            "description": "The EnergyManager enforces a limit using this command.",
            "arguments": {
                "uuid": {
                    "description": "UUID of node that this limit applies to",
                    "type": "string"
                },
                "limits_import": {
                    "description": "Enforced limits that must be respected.",
                    "type": "object",
                    "properties": {
                        "valid_until": {
                            "description": "Limits are valid until this timepoint in RFC3339 UTC. If no new update is received, power consumption must be stopped afer that timepoint.",
                            "type": "string",
                            "format": "date-time"
                        },
                        "request_parameters": {
                            "description": "Enforced limits",
                            "type": "object",
                            "ac_current_A": {
                                "description": "AC current limit object",
                                "type": "object",
                                "required": [
                                    "current_A"
                                ],
                                "properties": {
                                    "current_A": {
                                        "description": "AC current limit per phase in Ampere",
                                        "type": "number",
                                        "minimum": 0.0
                                    },
                                    "phase_count": {
                                        "description": "Limit to number of phases. Omit if number of phases are not limited.",
                                        "type": "integer",
                                        "minimum": 1,
                                        "maximum": 3
                                    }
                                },
                                "additionalProperties": false
                            },
                            "total_power_W": {
                                "description": "Total power limit in Watt. Can be used for DC or as additional limit for AC.",
                                "type": "number",
                                "minimum": 0.0
                            }
                        }
                    },
                    "additionalProperties": false
                },
                "limits_export": {
                    "description": "Enforced limits that must be respected.",
                    "type": "object",
                    "properties": {
                        "valid_until": {
                            "description": "Limits are valid until this timepoint in RFC3339 UTC. If no new update is received, power consumption must be stopped afer that timepoint.",
                            "type": "string",
                            "format": "date-time"
                        },
                        "request_parameters": {
                            "description": "Enforced limits",
                            "type": "object",
                            "ac_current_A": {
                                "description": "AC current limit object",
                                "type": "object",
                                "required": [
                                    "current_A"
                                ],
                                "properties": {
                                    "current_A": {
                                        "description": "AC current limit per phase in Ampere",
                                        "type": "number",
                                        "maximum": 0.0
                                    },
                                    "phase_count": {
                                        "description": "Limit to number of phases. Omit if number of phases are not limited.",
                                        "type": "integer",
                                        "minimum": 1,
                                        "maximum": 3
                                    }
                                },
                                "additionalProperties": false
                            },
                            "total_power_W": {
                                "description": "Total power limit in Watt. Can be used for DC or as additional limit for AC.",
                                "type": "number",
                                "maximum": 0.0
                            }
                        }
                    },
                    "additionalProperties": false
                },
                "schedule_import": {
                    "description": "Informative only. Do not use for actual limiting. Energy import/limits time series. The first entry is special as it will be active already now even if the timestamp is in the future, so it is good practice to set the first entry to current time. The time series can have arbitrary time difference between entries and all timestamps are absolute UTC time.",
                    "type": "array",
                    "items": {
                        "description": "One entry for the time series",
                        "type": "object",
                        "required": [
                            "timestamp",
                            "request_parameters"
                        ],
                        "properties": {
                            "timestamp": {
                                "description": "Absolute timestamp for this sample in RFC3339 UTC format https://datatracker.ietf.org/doc/html/rfc3339#section-5.6",
                                "type": "string",
                                "format": "date-time"
                            },
                            "request_parameters": {
                                "description": "Limit for this timestamp",
                                "type": "object",
                                "required": [
                                    "limit_type"
                                ],
                                "ac_current_A": {
                                    "description": "AC current limit object",
                                    "type": "object",
                                    "required": [
                                        "current_A"
                                    ],
                                    "properties": {
                                        "current_A": {
                                            "description": "AC current limit per phase in Ampere",
                                            "type": "number",
                                            "minimum": 0.0
                                        },
                                        "phase_count": {
                                            "description": "Limit to number of phases. Omit if number of phases are not limited.",
                                            "type": "integer",
                                            "minimum": 1,
                                            "maximum": 3
                                        }
                                    },
                                    "additionalProperties": false
                                },
                                "total_power_W": {
                                    "description": "Total power limit in Watt. Can be used for DC or as additional limit for AC.",
                                    "type": "number",
                                    "minimum": 0.0
                                }
                            },
                            "price_per_kwh": {
                                "description": "Price information for this timepoint",
                                "type": "object",
                                "required": [
                                    "value",
                                    "currency"
                                ],
                                "properties": {
                                    "value": {
                                        "description": "Price per kWh (cost)",
                                        "type": "number"
                                    },
                                    "currency": {
                                        "description": "Currency in 3 digit ISO 4217",
                                        "type": "string",
                                        "minLength": 3,
                                        "maxLength": 3
                                    }
                                }
                            }
                        },
                        "additionalProperties": false
                    }
                },
                "schedule_export": {
                    "description": "Informative only. Do not use for actual limiting. Energy export/limits time series. The first entry is special as it will be active already now even if the timestamp is in the future, so it is good practice to set the first entry to current time. The time series can have arbitrary time difference between entries and all timestamps are absolute UTC time.",
                    "type": "array",
                    "items": {
                        "description": "One entry for the time series",
                        "type": "object",
                        "required": [
                            "timestamp",
                            "request_parameters"
                        ],
                        "properties": {
                            "timestamp": {
                                "description": "Absolute timestamp for this sample in RFC3339 UTC format https://datatracker.ietf.org/doc/html/rfc3339#section-5.6",
                                "type": "string",
                                "format": "date-time"
                            },
                            "request_parameters": {
                                "description": "Limit for this timestamp",
                                "type": "object",
                                "required": [
                                    "limit_type"
                                ],
                                "ac_current_A": {
                                    "description": "AC current limit object",
                                    "type": "object",
                                    "required": [
                                        "current_A"
                                    ],
                                    "properties": {
                                        "current_A": {
                                            "description": "AC current limit per phase in Ampere",
                                            "type": "number",
                                            "maximum": 0.0
                                        },
                                        "phase_count": {
                                            "description": "Limit to number of phases. Omit if number of phases are not limited.",
                                            "type": "integer",
                                            "minimum": 1,
                                            "maximum": 3
                                        }
                                    },
                                    "additionalProperties": false
                                },
                                "total_power_W": {
                                    "description": "Total power limit in Watt. Can be used for DC or as additional limit for AC.",
                                    "type": "number",
                                    "maximum": 0.0
                                }
                            },
                            "price_per_kwh": {
                                "description": "Price information for this timepoint",
                                "type": "object",
                                "required": [
                                    "value",
                                    "currency"
                                ],
                                "properties": {
                                    "value": {
                                        "description": "Price per kWh (cost)",
                                        "type": "number"
                                    },
                                    "currency": {
                                        "description": "Currency in 3 digit ISO 4217",
                                        "type": "string",
                                        "minLength": 3,
                                        "maxLength": 3
                                    }
                                }
                            }
                        },
                        "additionalProperties": false
                    }
                }
            }
        }
    },
    "vars": {
        "energy": {
            "description": "Energy object to supply/limit energy import (direction from grid to car) and/or consume/limit energy export (car to grid).",
            "type": "object",
            "required": [
                "node_type",
                "uuid"
            ],
            "properties": {
                "children": {
                    "description": "Array of child nodes (in the direction to consumer/car",
                    "type": "array"
                },
                "node_type": {
                    "description": "Type of energy source/sink. Use Limit if this purely enforces limits but is not a physical energy source/sink.",
                    "type": "string",
                    "enum": [
                        "Grid",
                        "GridConnection",
                        "Solar",
                        "Battery",
                        "Fuse",
                        "Evse"
                    ]
                },
                "uuid": {
                    "description": "UUID for this node. This UUID will be used again when enforce_limits() command propagates through the tree.",
                    "type": "string"
                },
                "optimizer_target": {
                    "description": "User defined optimizer targets for this evse",
                    "type": "object",
                    "properties": {
                        "energy_amount_needed": {
                            "description": "Amount of kwh the car needs to fulfill its charging target",
                            "type": "number"
                        },
                        "charge_to_max_percent": {
                            "description": "Charge car battery to max NN percent",
                            "type": "number"
                        },
                        "car_battery_soc": {
                            "description": "Car battery State Of Charge in percent",
                            "type": "number"
                        },
                        "leave_time": {
                            "description": "RFC3339 UTC format time when the car needs to drive away with charging targets fullfilled. Will charge cheapest within this timeframe.",
                            "type": "string"
                        },
                        "price_limit": {
                            "description": "Always charge if price below this limit. This includes solar charging and price for solar energy if price levels set correctly.",
                            "type": "number"
                        },
                        "full_autonomy": {
                            "description": "Only charge from locally generated energy. Do not draw power from grid for charging.",
                            "type": "boolean"
                        }
                    },
                    "additionalProperties": false
                },
                "schedule_import": {
                    "description": "Energy import/limits time series. The first entry is special as it will be active already now even if the timestamp is in the future, so it is good practice to set the first entry to current time. The time series can have arbitrary time difference between entries and all timestamps are absolute UTC time.",
                    "type": "array",
                    "items": {
                        "description": "One entry for the time series",
                        "type": "object",
                        "required": [
                            "timestamp",
                            "request_parameters"
                        ],
                        "properties": {
                            "timestamp": {
                                "description": "Absolute timestamp for this sample in RFC3339 UTC format https://datatracker.ietf.org/doc/html/rfc3339#section-5.6",
                                "type": "string",
                                "format": "date-time"
                            },
                            "request_parameters": {
                                "description": "Limit for this timestamp",
                                "type": "object",
                                "required": [
                                    "limit_type"
                                ],
                                "limit_type": {
                                    "description": "Hard limits need to be enforced by EnergyManager, Soft limits may be ignored.",
                                    "type": "string",
                                    "enum": [
                                        "Hard",
                                        "Soft"
                                    ]
                                },
                                "ac_current_A": {
                                    "description": "AC current limit object",
                                    "type": "object",
                                    "required": [
                                        "max_current_A"
                                    ],
                                    "properties": {
                                        "max_current_A": {
                                            "description": "Max AC current limit per phase in Ampere",
                                            "type": "number",
                                            "minimum": 0.0
                                        },
                                        "min_current_A": {
                                            "description": "Minimal AC current limit per phase in Ampere to be able to charge",
                                            "type": "number",
                                            "minimum": 0.0
                                        },
                                        "max_phase_count": {
                                            "description": "Max Limit of number of phases. Omit if number of phases are not limited.",
                                            "type": "integer",
                                            "minimum": 1,
                                            "maximum": 3
                                        },
                                        "min_phase_count": {
                                            "description": "Minimum number of phases that can be used for proper operation.",
                                            "type": "integer",
                                            "minimum": 1,
                                            "maximum": 3
                                        },
                                        "supports_changing_phases_during_charging": {
                                            "description": "Indicate whether phase switching is allowed during charging or not",
                                            "type": "boolean"
                                        }
                                    },
                                    "additionalProperties": false
                                },
                                "total_power_W": {
                                    "description": "Total power limit in Watt. Can be used for DC or as additional limit for AC.",
                                    "type": "number",
                                    "minimum": 0.0
                                }
                            },
                            "price_per_kwh": {
                                "description": "Price information for this timepoint",
                                "type": "object",
                                "required": [
                                    "value",
                                    "currency"
                                ],
                                "properties": {
                                    "value": {
                                        "description": "Price per kWh (cost)",
                                        "type": "number"
                                    },
                                    "currency": {
                                        "description": "Currency in 3 digit ISO 4217",
                                        "type": "string",
                                        "minLength": 3,
                                        "maxLength": 3
                                    }
                                }
                            }
                        },
                        "additionalProperties": false
                    }
                },
                "schedule_export": {
                    "description": "Energy export/limits time series. The first entry is special as it will be active already now even if the timestamp is in the future, so it is good practice to set the first entry to current time. The time series can have arbitrary time difference between entries and all timestamps are absolute UTC time.",
                    "type": "array",
                    "items": {
                        "description": "One entry for the time series",
                        "type": "object",
                        "required": [
                            "timestamp",
                            "request_parameters"
                        ],
                        "properties": {
                            "timestamp": {
                                "description": "Absolute timestamp for this sample in RFC3339 UTC format https://datatracker.ietf.org/doc/html/rfc3339#section-5.6",
                                "type": "string",
                                "format": "date-time"
                            },
                            "request_parameters": {
                                "description": "Limit for this timestamp",
                                "type": "object",
                                "required": [
                                    "limit_type"
                                ],
                                "limit_type": {
                                    "description": "Hard limits need to be enforced by EnergyManager, Soft limits may be ignored.",
                                    "type": "string",
                                    "enum": [
                                        "Hard",
                                        "Soft"
                                    ]
                                },
                                "ac_current_A": {
                                    "description": "AC current limit object",
                                    "type": "object",
                                    "required": [
                                        "max_current_A"
                                    ],
                                    "properties": {
                                        "max_current_A": {
                                            "description": "Max AC current limit per phase in Ampere",
                                            "type": "number",
                                            "minimum": 0.0
                                        },
                                        "min_current_A": {
                                            "description": "Minimal AC current limit per phase in Ampere to be able to discharge",
                                            "type": "number",
                                            "minimum": 0.0
                                        },
                                        "max_phase_count": {
                                            "description": "Max Limit of number of phases. Omit if number of phases are not limited.",
                                            "type": "integer",
                                            "minimum": 1,
                                            "maximum": 3
                                        },
                                        "min_phase_count": {
                                            "description": "Minimum number of phases that can be used for proper operation.",
                                            "type": "integer",
                                            "minimum": 1,
                                            "maximum": 3
                                        },
                                        "supports_changing_phases_during_charging": {
                                            "description": "Indicate whether phase switching is allowed during charging or not",
                                            "type": "boolean"
                                        }
                                    },
                                    "additionalProperties": false
                                },
                                "total_power_W": {
                                    "description": "Total power limit in Watt. Can be used for DC or as additional limit for AC.",
                                    "type": "number",
                                    "maximum": 0.0
                                }
                            },
                            "price_per_kwh": {
                                "description": "Price information for this timepoint",
                                "type": "object",
                                "required": [
                                    "value",
                                    "currency"
                                ],
                                "properties": {
                                    "value": {
                                        "description": "Price per kWh (earning)",
                                        "type": "number"
                                    },
                                    "currency": {
                                        "description": "Currency in 3 digit ISO 4217",
                                        "type": "string",
                                        "minLength": 3,
                                        "maxLength": 3
                                    }
                                },
                                "additionalProperties": false
                            }
                        },
                        "additionalProperties": false
                    }
                },
                "energy_usage": {
                    "description": "Energy usage of this node (powermeter struct)",
                    "type": "object"
                }
            }
        }
    }
}
